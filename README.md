# README — Javeriana Courses Search & Recommender Lab

> **Goal**  
> Build an end-to-end pipeline that: crawls the Javeriana’s public “Programas” catalog, stores only _Courses_ in a database, indexes their text, enables word lookups and interest-based search, and computes course similarity using cosine distance.

---

## Table of Contents
1. [Project Structure](#project-structure)  
2. [What Each File Does](#what-each-file-does)  
3. [Data Model](#data-model)  
4. [Environment & Dependencies](#environment--dependencies)  
5. [Database Creation & Indexing](#database-creation--indexing)  
6. [Crawler: How It Works](#crawler-how-it-works)  
7. [SQL: Word → URL Lookups](#sql-word--url-lookups)  
8. [Search: Interest-Based Retrieval](#search-interest-based-retrieval)  
9. [Similarity: Cosine [0,1]](#similarity-cosine-01)  
10. [End-to-End Runbook (Windows-friendly)](#end-to-end-runbook-windows-friendly)  
11. [Limitations](#limitations)  
12. [Conclusions](#conclusions)  

---

## Project Structure

```
lab-cursos-javeriana/
├─ README.md                    # This file
├─ requirements.txt             # Python dependencies
├─ crawler.py                   # Selenium crawler (only Courses, p1..p69)
├─ search.py                    # Search by interests (FTS 
├─ compare.py                   # Cosine similarity [0,1]
├─ sql/
│  ├─ 01_schema.sql             # Tables 
│  └─ 02_queries_word_lookup.sql# Word→URL SQL queries (FTS + LIKE fallback)
└─ data/
   └─ cursos.sqlite             # SQLite DB (generated by the crawler)
```


---

## What Each File Does

- **`crawler.py`**  
  Crawls the catalog at `https://educacionvirtual.javeriana.edu.co/nuestros-programas-nuevo`.  
  It extracts only items whose badge is “Curso” and visits each detail page to scrape:
  `title, price, category (Nivel), duration, start_date, value_proposal (Propuesta de valor), tutoria (Tutoría), description`.  
  Results are upserted into `data/cursos.sqlite`.  

- **`sql/01_schema.sql`**  
  Creates the `courses` table and an **FTS5** index (`courses_fts`) for full-text search, plus `terms` and `synonyms` tables (for optional synonym expansion).

- **`sql/02_queries_word_lookup.sql`**  
  SQL templates to answer “In which URLs does word X appear?” via **FTS** and a backup **LIKE** query.

- **`search.py`**  
  Command-line search tool. Reads a comma-separated list of interests, optionally expands them with synonyms if you seed any in the DB, and executes an **FTS** query. Prints URLs, titles, and scores.

- **`compare.py`**  
  Computes cosine similarity in [0,1] between two courses (by IDs, URLs, or “title contains”). Uses TF-IDF with Spanish stopwords (embedded) and accent normalization.

---

## Data Model

**Table: `courses`**

| Column            | Type     | Notes |
|-------------------|----------|------|
| `course_id`       | INTEGER  | PK, autoincrement |
| `url`             | TEXT     | Unique, absolute URL of the detail page |
| `title`           | TEXT     | Course title (from detail page) |
| `category`        | TEXT     | **Nivel** (e.g., Básico/Intermedio/Avanzado) |
| `modality`        | TEXT     | Not always available (NULL if absent) |
| `duration`        | TEXT     | e.g., “120 Horas” |
| `price`           | TEXT     | e.g., “$1.760.000” |
| `start_date`      | TEXT     | e.g., “Septiembre 25 de 2025” |
| `location`        | TEXT     | Not always available (NULL if absent) |
| `value_proposal`  | TEXT     | From **Propuesta de valor** section |
| `tutoria`         | TEXT     | From **TUTORÍA** field |
| `description`     | TEXT     | From **Presentación del programa** section |
| `raw_html`        | TEXT     | Optional (saved if `--save-html`) |
| `last_crawled_at` | TEXT     | UTC ISO timestamp |

**Full-Text Index: `courses_fts`**  
Virtual FTS5 table linked to `courses` (triggers keep it in sync). Indexed fields:
`title, description, category, value_proposal, tutoria`..


---

## Environment & Dependencies

- **Python**: 3.10+  
- **Packages** (see `requirements.txt`):
  - `selenium`, `webdriver-manager`
  - `beautifulsoup4`, `lxml`, `html5lib`
  - `scikit-learn`
  - `pandas` (optional), `nltk` (optional)
- **Browser Driver**: Installed automatically by `webdriver-manager` (Chrome).

---

## Database Creation & Indexing

Create the database once (or whenever you want to reset) by running the create_db.py file:

```bash
python create_db.py
```

or by running the next bash:

```bash
python - << "PY"
import sqlite3, os
os.makedirs("data", exist_ok=True)
con = sqlite3.connect("data/cursos.sqlite")
con.executescript(open("sql/01_schema.sql","r",encoding="utf-8").read())
con.commit(); con.close()
print("DB created at data/cursos.sqlite")
PY
```

This script:
- Creates `courses` table
- Creates FTS5 virtual table `courses_fts` and triggers
- Creates `terms` / `synonyms` (unused unless you seed them later)

---

## Crawler: How It Works

### What it scrapes and why
- **Catalog page** cards are `<li class="item-programa ais-Hits-item ...">`.
- The **program type** is a badge at `<div class="card-type ...">Curso|Diplomado|...>`.  
  We **filter strictly** by `"Curso"` to meet the requirement “only courses”.

### Pagination
- The catalog has pagination controls as `<li id="p1"> ... p69`.
- The crawler iterates `p1..p{N}` (default N=69), clicking each pagination item with Selenium.
- After each click, it **waits** until the selected page’s first card **changes**, ensuring the new page is loaded.

### Course links
- From each card, it takes the anchor `<a href="/path">` (title link preferred; falls back to any `<a>` in the card).
- Links are resolved to absolute URLs.

### Detail page parsing
Selectors tailored to the site layout:
- **Title**: `h2.font-weight-bold.mb-md-0` (fallback to `h1/h2`)  
- **Price**: `.course-price`  
- **Sidebar fields** (by label):  
  - `NIVEL` → `category`  
  - `DURACIÓN` → `duration`  
  - `TUTORÍA` → `tutoria`  
  - `INICIO` → `start_date`  
- **Value Proposal**: `.course-wrapper-seccion.course-wrapper-content--proposal` (header removed from text)  
- **Description**: `.course-wrapper-seccion.course-wrapper-content--presentation` (header removed from text)

### DB upsert
Each course is inserted or updated (`ON CONFLICT(url) DO UPDATE`).  
Triggers keep FTS updated automatically.

### Politeness & Reliability
- Waits between actions (`--delay`, default 1.0 sec) to avoid hammering the server.
- Extra waits ensure the correct page is loaded before scraping.

### Run
```bash
python crawler.py --db "data\cursos.sqlite" --start "https://educacionvirtual.javeriana.edu.co/nuestros-programas-nuevo" --pages 69 --delay 1.0 

```
> Add `--show` to open the browser window while debugging.

---

## SQL: Word → URL Lookups

**File:** `sql/02_queries_word_lookup.sql`

### FTS 
Find URLs where a word or phrase appears across title/description/category/value_proposal/tutoria:
```sql
SELECT c.url, c.title
FROM courses_fts f
JOIN courses c ON c.course_id = f.rowid
WHERE courses_fts MATCH :palabra;
```

### LIKE fallback (if FTS not available)
```sql
SELECT url, title
FROM courses
WHERE lower(title)          LIKE '%' || lower(:palabra) || '%'
   OR lower(description)    LIKE '%' || lower(:palabra) || '%'
   OR lower(category)       LIKE '%' || lower(:palabra) || '%'
   OR lower(value_proposal) LIKE '%' || lower(:palabra) || '%'
   OR lower(tutoria)        LIKE '%' || lower(:palabra) || '%';
```

**Quick test from Python:**

By running the following command, it will appear the courses that have the word 'marketing' with their corresponding URL's. To search another word, just change the 'marketing' with another word.
```bat
python -c "import sqlite3; con=sqlite3.connect(r'data\cursos.sqlite'); word='marketing'; q='SELECT c.url, c.title FROM courses_fts f JOIN courses c ON c.course_id=f.rowid WHERE courses_fts MATCH ? ORDER BY rank LIMIT 50;'; [print(f'- {title} -> {url}') for url,title in con.execute(q,(word,))]; con.close()"

```

---

## Search: Interest-Based Retrieval

**File:** `search.py`

### How it works
1. **Reads interests** from `--intereses "term1, term2, term3"`.
2. **Optional synonyms**: if you seed `terms/synonyms`, `search.py` expands each term with its synonyms.  
3. Builds an **FTS MATCH** query combining each term and its synonyms with `OR`.
4. Executes FTS and returns top results ordered by BM25 (if available) or row order fallback.

### Example
```bat
python search.py --db data\cursos.sqlite --intereses "inteligencia artificial, python, datos" --top 15
```

---

## Similarity: Cosine [0,1]

**File:** `compare.py`

### What it does
- Builds **TF-IDF** vectors from concatenated text: `title + description + value_proposal + tutoria`.  
- Computes **cosine similarity** in `[0,1]`.  
- Uses **Spanish stopwords** (embedded list) and accent normalization to get cleaner signals.  
- Robust to empty or stopword-only inputs (returns `0.0`).

### Run examples (Windows)
By IDs:
```bat
python compare.py --db data\cursos.sqlite --ids 10 25
```
By URL:
```bat
python compare.py --db data\cursos.sqlite --urls "https://educacionvirtual.javeriana.edu.co/curso-a" "https://educacionvirtual.javeriana.edu.co/curso-b"
```
By “title contains”:
```bat
python compare.py --db data\cursos.sqlite --titles "arquitectura" "interiorismo"
```

---

## End-to-End Runbook (Windows-friendly)

```bat
REM 0) Activate environment
.\.venv\Scripts\activate

REM 1) Create / reset DB schema
python - << "PY"
import sqlite3, os
os.makedirs("data", exist_ok=True)
con = sqlite3.connect("data/cursos.sqlite")
con.executescript(open("sql/01_schema.sql","r",encoding="utf-8").read())
con.commit(); con.close()
print("DB ready.")
PY

REM 2) Crawl (headless). Add --show to debug visually
python crawler.py --db data\cursos.sqlite --start "https://educacionvirtual.javeriana.edu.co/nuestros-programas-nuevo" --pages 69 --delay 1.0

REM 3) Lookup a word’s URLs (FTS)
python - << "PY"
import sqlite3
con = sqlite3.connect(r"data\cursos.sqlite")
word = "marketing"
for url,title in con.execute("""
SELECT c.url, c.title
FROM courses_fts f
JOIN courses c ON c.course_id = f.rowid
WHERE courses_fts MATCH ?
ORDER BY rank
LIMIT 20
""", (word,)):
    print("-", title, "->", url)
con.close()
PY

REM 4) Search by interests
python search.py --db data\cursos.sqlite --intereses "inteligencia artificial, python, datos" --top 10

REM 5) Compare courses (cosine similarity)
python compare.py --db data\cursos.sqlite --ids 1 2
```

---

## Limitations

- Site HTML may change: selectors might need adjustment if classes/IDs change.  
- Not all fields exist for every course (e.g., `modality`, `location`).  
- Dates and prices are captured as text; normalization to structured types is possible but out of scope here.  


---

## Conclusions

- The crawler successfully populated the database (e.g., ~479 courses) focusing only on Courses, not Diplomas/Seminars/Workshops.  
- FTS5 delivered fast and relevant search results. The system answers word→URL lookups and supports interest searches.  
- Cosine similarity provided an effective signal to recommend related courses based on textual content.  
- The pipeline is modular: we can re-crawl, re-index, and later add a synonyms seed without changing the DB contract.

---